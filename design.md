

### **4. 系统设计**

#### 4.1 系统架构（模块划分）
本系统采用**分层与模块化**的软件架构，并建议在**FreeRTOS实时操作系统**上运行，以实现多任务的并发执行与资源管理。系统自上而下分为以下四层：

*   **驱动层：** 为具体的外设提供初始化和基础读写操作，是软件与硬件的桥梁。
*   **算法层：** 封装核心控制与数据处理算法，为应用层提供纯净的计算服务。
*   **应用层：** 实现核心业务逻辑，通过多个独立的任务来组织功能，是系统的"大脑"。

**系统架构框图：**
```
+-----------------------------------------------+
|                 应用层                         |
|           (FreeRTOS Tasks)                    |
|  +---------+ +----------+ +----------------+  |
|  |Balance  | |Decision  | |Remote_Ctrl     |  |
|  |_Task    | |_Task     | |_Task           |  |
|  +---------+ +----------+ +----------------+  |
|  +---------+ +----------+ +----------------+  |
|  |Vision   | |Ultrasonic||OLED_Display     |  |
|  |Comm_Task| |_Task    | |_Task            |  |
|  +---------+ +----------+ +----------------+  |
+----------------------|------------------------+
                       |
+-----------------------------------------------+
|                 算法层                         |
|        (Pure C Algorithms)                    |
|  +------------------+ +---------------------+ |
|  |   姿态解算模块    | |    PID控制模块       | |
|  |  (IMU_Fusion)    | | (PID_Controller)    | |
|  +------------------+ +---------------------+ |
+----------------------|------------------------+
                       |
+-----------------------------------------------+
|                 驱动层                        |
|           (Device Drivers)                    |
|  +---------+ +----------+ +----------------+  |
|  |MPU6050  | |  Motor   | |   Bluetooth    |  |
|  |驱动     | |  驱动     | |    驱动        |  |
|  +---------+ +----------+ +----------------+  |
|  +---------+ +----------+ +----------------+  |
|  |K210通信 | |Ultrasonic| |     OLED       |  |
|  |驱动     | |   驱动   | |     驱动        |  |
|  +---------+ +----------+ +----------------+  |
+----------------------|------------------------+
                       |
+-----------------------------------------------+
|              硬件抽象层 (HAL)                  |
|          (STM32 Peripherals)                  |
+-----------------------------------------------+
```

---

#### 4.2 软件模块详细设计

**驱动层模块 (Device Drivers)**

| 模块名称 | `mpu6050` (MPU6050驱动) |
| :--- | :--- |
| **定义** | 负责MPU6050传感器的底层初始化和数据读取。 |
| **功能** | 1. 初始化I2C总线和MPU6050芯片。<br>2. 读取加速度计和陀螺仪的六轴原始数据。<br>3. 提供传感器自检和校准功能。 |
| **输入** | - I2C读写指令。 |
| **输出** | - 六轴原始数据（`int16_t ax, ay, az, gx, gy, gz`）。 |
| **接口定义** | `uint8_t MPU6050_Init(void);`<br>`uint8_t MPU6050_GetData(int16_t *accel, int16_t *gyro);` |
| **实现原理** | 通过STM32的HAL库I2C函数，按照MPU6050数据手册的寄存器地址，进行读写操作。 |
| **依赖关系** | 依赖硬件抽象层的 `I2C` 和 `GPIO`。 |

---

| 模块名称 | `motor` (电机驱动) |
| :--- | :--- |
| **定义** | 负责控制电机驱动芯片（如TB6612FNG），管理电机的运动。 |
| **功能** | 1. 初始化PWM和编码器接口的定时器。<br>2. 设置电机的转速和方向（输出PWM）。<br>3. 读取编码器值，获取电机实际转速。 |
| **输入** | - 目标PWM值（带正负号，表示方向）。<br>- 编码器脉冲计数。 |
| **输出** | - 电机驱动芯片的PWM和方向控制信号。<br>- 计算出的电机转速值。 |
| **接口定义** | `void Motor_Init(void);`<br>`void Motor_SetPWM(Motor_ID motor, int16_t pwm);`<br>`int32_t Encoder_GetCount(Motor_ID motor);` |
| **实现原理** | 使用STM32的定时器产生PWM波控制电机速度，通过GPIO电平控制方向。使用定时器的编码器模式直接读取正交编码器的脉冲。 |
| **依赖关系** | 依赖硬件抽象层的 `TIM` (PWM和Encoder), `GPIO`。 |

---

| 模块名称 | `bluetooth` (蓝牙驱动) |
| :--- | :--- |
| **定义** | 负责蓝牙模块的初始化和数据收发。 |
| **功能** | 1. 初始化UART串口。<br>2. 发送数据到手机APP/上位机。<br>3. 接收来自手机APP/上位机的数据。 |
| **输入** | - 待发送的数据字节流。<br>- 串口接收到的原始字节流。 |
| **输出** | - 通过串口发送的数据。<br>- 接收到的原始数据（供上层解析）。 |
| **接口定义** | `void Bluetooth_Init(void);`<br>`void Bluetooth_SendData(uint8_t *data, uint16_t len);`<br>`uint16_t Bluetooth_ReceiveData(uint8_t *buf, uint16_t len);` |
| **实现原理** | 配置STM32的UART外设，使用中断或DMA方式实现数据的异步收发。 |
| **依赖关系** | 依赖硬件抽象层的 `UART`。 |

---

| 模块名称 | `k210_comm` (K210通信驱动) |
| :--- | :--- |
| **定义** | 负责与K210视觉模块的串口通信。 |
| **功能** | 1. 初始化与K210通信的UART串口。<br>2. 发送配置指令或请求数据给K210。<br>3. 接收K210发送的识别结果数据。 |
| **输入** | - 待发送给K210的指令或数据。 |
| **输出** | - 从K210接收到的原始数据流。 |
| **接口定义** | `void K210_Comm_Init(void);`<br>`void K210_SendCmd(uint8_t cmd);`<br>`uint16_t K210_ReceiveData(uint8_t *buf, uint16_t len);` |
| **实现原理** | 与蓝牙驱动类似，基于UART通信，按照与K210约定的波特率和格式进行数据交换。 |
| **依赖关系** | 依赖硬件抽象层的 `UART`。 |

---

| 模块名称 | `ultrasonic` (超声波驱动) |
| :--- | :--- |
| **定义** | 负责超声波传感器(HC-SR04)的测距操作。 |
| **功能** | 1. 初始化Trig和Echo引脚。<br>2. 触发一次测距脉冲。<br>3. 测量Echo引脚高电平持续时间并计算距离。 |
| **输入** | - 无（主动触发）。 |
| **输出** | - 测量得到的距离值（单位：cm）。 |
| **接口定义** | `void Ultrasonic_Init(void);`<br>`uint16_t Ultrasonic_GetDistance(void);` |
| **实现原理** | 通过GPIO发送一个10us以上的高脉冲给Trig引脚，然后通过输入捕获或简单延时测量Echo引脚高电平的持续时间，根据声速公式计算距离。 |
| **依赖关系** | 依赖硬件抽象层的 `GPIO` 和 `TIM`（用于输入捕获）。 |

---

| 模块名称 | `oled` (OLED显示驱动) |
| :--- | :--- |
| **定义** | 负责OLED显示屏(SSD1306)的初始化和基本图形显示。 |
| **功能** | 1. 初始化I2C/SPI通信。<br>2. 实现画点、画线、清屏等基本绘图函数。<br>3. 显示字符串和数字。 |
| **输入** | - 待显示的字符串、数字或图形数据。 |
| **输出** | - 发送给OLED屏幕的控制指令和显示数据。 |
| **接口定义** | `void OLED_Init(void);`<br>`void OLED_Clear(void);`<br>`void OLED_ShowString(uint8_t x, uint8_t y, char *str);`<br>`void OLED_Refresh(void);` |
| **实现原理** | 通过I2C或SPI接口，按照SSD1306数据手册的指令集，控制屏幕的显存，最终调用Refresh函数将显存内容更新到屏幕。 |
| **依赖关系** | 依赖硬件抽象层的 `I2C` 或 `SPI`。 |

---

**算法层模块 (Algorithms)**

| 模块名称 | `IMU_Fusion` (姿态解算模块) |
| :--- | :--- |
| **定义** | 对MPU6050的原始数据进行滤波和融合，解算得到稳定可靠的姿态角。 |
| **功能** | 1. 对加速度计和陀螺仪原始数据进行校准和单位转换。<br>2. 执行传感器融合算法（如互补滤波），输出精确的俯仰角（Pitch）。 |
| **输入** | - MPU6050的原始三轴加速度和三轴陀螺仪数据（`int16_t`）。 |
| **输出** | - 融合后的俯仰角（`float`，单位：度或弧度）。 |
| **接口定义** | `void IMU_Fusion_Init(void);`<br>`float IMU_Fusion_GetPitch(void);` |
| **实现原理** | 利用加速度计在长期尺度上的准确性，和陀螺仪在短期尺度上的无漂移特性，通过互补滤波算法将它们结合起来，得到既快速又准确的姿态角。 |
| **依赖关系** | 依赖 `mpu6050` 驱动层模块以获取原始数据。 |

---

| 模块名称 | `PID_Controller` (PID控制模块) |
| :--- | :--- |
| **定义** | 提供一个通用、可配置的PID控制器实现。 |
| **功能** | 1. 进行PID位置式或增量式计算。<br>2. 支持输出限幅和积分抗饱和。 |
| **输入** | - 目标值（`target`）<br>- 当前测量值（`measure`）<br>- PID参数（Kp, Ki, Kd）。 |
| **输出** | - PID计算后的控制量输出（`output`）。 |
| **接口定义** | `typedef struct { float Kp, Ki, Kd; float integral, last_error; ... } PID_TypeDef;`<br>`float PID_Calculate(PID_TypeDef *pid, float target, float measure);` |
| **实现原理** | 实现标准的PID控制算法：`Output = Kp * error + Ki * ∫error dt + Kd * d(error)/dt`。在结构体中维护积分项和上一次的误差，以实现增量计算。 |
| **依赖关系** | 是一个纯算法模块，不依赖其他硬件模块。 |

---

**应用层模块 (Application Tasks)**

| 模块名称 | `Balance_Task` (平衡控制任务) |
| :--- | :--- |
| **定义** | 系统中优先级最高的核心任务，负责维持小车的直立平衡。 |
| **功能** | 1. 周期性调用姿态解算模块，获取精确的俯仰角。<br>2. 调用平衡PID控制器，计算维持平衡所需的电机扭矩。<br>3. 综合遥控指令的速度前馈，调用电机驱动模块输出最终PWM。 |
| **输入** | - 来自`IMU_Fusion`的俯仰角。<br>- 来自`Decision_Task`的目标速度指令。 |
| **输出** | - 电机A和电机B的PWM控制信号（通过`motor`模块输出）。 |
| **接口定义** | `void Balance_Task(void *pvParameters);` (FreeRTOS任务函数) |
| **实现原理** | 在FreeRTOS中创建一个高优先级任务，以固定短周期（如2-5ms）运行。读取当前姿态，通过PID运算，动态调整电机输出，形成一个高速闭环控制系统。 |
| **依赖关系** | 依赖 `IMU_Fusion`, `PID_Controller`, `motor`, `Decision_Task`。 |

---

| 模块名称 | `Decision_Task` (行为决策任务) |
| :--- | :--- |
| **定义** | 系统的"大脑"，负责融合多路输入信号，并决策出最终的运动指令。 |
| **功能** | 1. 接收并解析来自`Remote_Ctrl_Task`的遥控指令。<br>2. 接收来自`Vision_Comm_Task`的视觉避障指令和`Ultrasonic_Task`的跟随指令。<br>3. 根据当前工作模式，仲裁并输出最终的目标速度/转向指令。<br>4. 处理脚本动作的逻辑序列。 |
| **输入** | - 遥控指令、视觉指令、超声波距离数据、系统模式标志。 |
| **输出** | - 最终的目标速度（左轮、右轮）指令，发送给`Balance_Task`。 |
| **接口定义** | `void Decision_Task(void *pvParameters);` (FreeRTOS任务函数)<br>`void Decision_SetTargetVelocity(int16_t left, int16_t right);` |
| **实现原理** | 作为一个中优先级的FreeRTOS任务运行。它维护一个状态机，根据当前模式选择指令来源。例如，在避障模式下，视觉指令的优先级高于遥控指令。 |
| **依赖关系** | 依赖 `Remote_Ctrl_Task`, `Vision_Comm_Task`, `Ultrasonic_Task`，并为 `Balance_Task` 提供服务。 |

---

| 模块名称 | `Remote_Ctrl_Task` (远程通信任务) |
| :--- | :--- |
| **定义** | 负责与手机APP/上位机进行蓝牙通信，接收控制指令和发送状态数据。 |
| **功能** | 1. 从蓝牙串口接收数据帧。<br>2. 解析协议，将原始数据转换为内部控制指令。<br>3. 将系统状态数据打包，通过蓝牙发送回上位机。 |
| **输入** | - 蓝牙串口接收到的原始字节流。<br>- 需要发送的系统状态数据。 |
| **输出** | - 解析后的标准化遥控指令（发送给`Decision_Task`）。<br>- 发送给上位机的数据包。 |
| **接口定义** | `void Remote_Ctrl_Task(void *pvParameters);` (FreeRTOS任务函数)<br>`void Remote_SendStatus(float angle, uint8_t mode);` |
| **实现原理** | 一个中低优先级的FreeRTOS任务，循环检查串口接收缓冲区。使用一个简单的协议解析器来确保数据的完整性。 |
| **依赖关系** | 依赖 `bluetooth` 驱动层模块。与 `Decision_Task` 和 `OLED_Display_Task` 有数据交互。 |

---

| 模块名称 | `Vision_Comm_Task` (视觉通信任务) |
| :--- | :--- |
| **定义** | 负责与K210视觉模块进行串口通信，接收识别结果。 |
| **功能** | 1. 从K210串口接收数据帧。<br>2. 解析预设的视觉协议。<br>3. 将解析出的障碍物方位或手势识别结果发送给`Decision_Task`。 |
| **输入** | - K210串口发送来的原始字节流。 |
| **输出** | - 解析后的视觉指令（如枚举类型：`VISION_OBSTACLE_LEFT`）。 |
| **接口定义** | `void Vision_Comm_Task(void *pvParameters);` (FreeRTOS任务函数) |
| **实现原理** | 与`Remote_Ctrl_Task`类似，是一个独立的任务，负责解析与K210约定的通信协议，将结果通过队列或全局变量传递给决策层。 |
| **依赖关系** | 依赖 `k210_comm` 驱动层模块。为 `Decision_Task` 提供服务。 |

---

| 模块名称 | `Ultrasonic_Task` (超声波任务) |
| :--- | :--- |
| **定义** | 负责周期性地触发超声波测距并处理距离数据。 |
| **功能** | 1. 控制超声波模块发起一次测距。<br>2. 读取并滤波返回的距离值。<br>3. 在跟随模式下，根据距离值计算所需的速度指令。 |
| **输入** | - 超声波模块返回的高电平脉冲宽度。 |
| **输出** | - 处理后的距离值（单位：cm）。<br>- 在跟随模式下，输出目标速度指令给`Decision_Task`。 |
| **接口定义** | `void Ultrasonic_Task(void *pvParameters);` (FreeRTOS任务函数)<br>`uint16_t Ultrasonic_GetDistance(void);` |
| **实现原理** | 一个固定周期运行的任务。通过GPIO触发测距，然后捕获输入脉冲。使用一个PID控制器，将测量距离与预设跟随距离比较，计算出跟随速度。 |
| **依赖关系** | 依赖 `ultrasonic` 驱动层模块。与 `Decision_Task` 有紧密的数据交互。 |

---

| 模块名称 | `OLED_Display_Task` (显示任务) |
| :--- | :--- |
| **定义** | 负责刷新OLED显示屏，输出系统状态信息。 |
| **功能** | 1. 从其他模块收集需要显示的数据。<br>2. 将数据格式化为字符串或图形。<br>3. 控制OLED显示屏分页或动态更新显示内容。 |
| **输入** | - 来自各模块的系统状态数据。 |
| **输出** | - OLED屏的显示内容。 |
| **接口定义** | `void OLED_Display_Task(void *pvParameters);` (FreeRTOS任务函数) |
| **实现原理** | 一个低优先级的任务，以较低的频率（如10Hz）运行，避免频繁刷新占用过多CPU。它负责组织界面布局和内容更新。 |
| **依赖关系** | 依赖 `oled` 驱动层模块。需要从几乎所有应用层和算法层模块读取状态数据。 |

---

